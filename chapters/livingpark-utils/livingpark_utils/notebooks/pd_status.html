
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>6. 👋 Introduction &#8212; LivingPark Book</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="prev" title="2. Introduction" href="mri_metadata.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">LivingPark Book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../../introduction.html">
                    <no title>
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Structural MRI
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../scherfler-etal/scherfler-etal.html">
   1. Replication: Scherfler
   <em>
    et al
   </em>
   , 2011
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Study Data Pre-Processing
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="mri_metadata.html">
   2. Introduction
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   6. 👋 Introduction
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/chapters/livingpark-utils/livingpark_utils/notebooks/pd_status.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/executablebooks/jupyter-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fchapters/livingpark-utils/livingpark_utils/notebooks/pd_status.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../../_sources/chapters/livingpark-utils/livingpark_utils/notebooks/pd_status.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   6. 👋 Introduction
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-download">
   7. 🔽 Data download
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inconsistencies">
   8. ⁉️ Inconsistencies
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#records-with-no-value">
     8.1. Records with no value
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pdtrtmnt-0-and-pdstate-on">
     8.2. PDTRTMNT=0 and PDSTATE=ON
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pdtrtmnt-0-and-pdmedtm-not-empty">
     8.3. PDTRTMNT=0 and PDMEDTM not empty
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#event-id-sc-and-pdtrtmnt-1">
     8.4. EVENT_ID = SC and PDTRTMNT = 1
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pdstate-on-and-examtm-pdmedtm">
     8.5. PDSTATE=ON and EXAMTM&lt;PDMEDTM
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visits-with-3-exams">
     8.6. Visits with 3 exams
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imputation-of-missing-pdstate-or-pdtrtmnt">
   9. 🕵️ Imputation of missing PDSTATE or PDTRTMNT
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-1-pdstate-off-and-pdtrtmnt-nan">
     9.1. Case 1: PDSTATE=OFF and PDTRTMNT=NaN
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-2-pdstate-nan-and-pdtrtmnt-0">
     9.2. Case 2: PDSTATE=NaN and PDTRTMNT=0
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-3-pdstate-nan-and-pdtrtmnt-1">
     9.3. Case 3: PDSTATE=NaN and PDTRTMNT=1
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-3-a-visits-with-two-exams">
       9.3.1. Case 3.a: visits with two exams
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-3-b-i-visits-with-one-exam-missing-examtm-or-pdmedtm">
       9.3.2. Case 3.b.i: visits with one exam, missing EXAMTM or PDMEDTM
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-3-b-ii-visits-with-one-exam-pdmedtm-earlier-than-examtm">
       9.3.3. Case 3.b.ii: visits with one exam, PDMEDTM earlier than EXAMTM
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-3-b-iii-pdmedtm-is-later-than-examtm">
       9.3.4. Case 3.b.iii: PDMEDTM is later than EXAMTM
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#case-3-b-iii-a-pdmedtm-is-after-4pm">
         9.3.4.1. Case 3.b.iii.a: PDMEDTM is after 4pm
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#case-3-b-iii-a-pdmedtm-is-before-4pm">
         9.3.4.2. Case 3.b.iii.a: PDMEDTM is before 4pm
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-4-pdstate-nan-and-pdtrtmnt-nan">
     9.4. Case 4: PDSTATE=NaN and PDTRTMNT=NaN
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-5-pdstate-on-and-pdtrtmnt-nan">
     9.5. Case 5: PDSTATE=ON and PDTRTMNT=NaN
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sanity-checks">
   10. ⚕️ Sanity checks
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>👋 Introduction</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   6. 👋 Introduction
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-download">
   7. 🔽 Data download
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inconsistencies">
   8. ⁉️ Inconsistencies
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#records-with-no-value">
     8.1. Records with no value
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pdtrtmnt-0-and-pdstate-on">
     8.2. PDTRTMNT=0 and PDSTATE=ON
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pdtrtmnt-0-and-pdmedtm-not-empty">
     8.3. PDTRTMNT=0 and PDMEDTM not empty
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#event-id-sc-and-pdtrtmnt-1">
     8.4. EVENT_ID = SC and PDTRTMNT = 1
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pdstate-on-and-examtm-pdmedtm">
     8.5. PDSTATE=ON and EXAMTM&lt;PDMEDTM
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visits-with-3-exams">
     8.6. Visits with 3 exams
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imputation-of-missing-pdstate-or-pdtrtmnt">
   9. 🕵️ Imputation of missing PDSTATE or PDTRTMNT
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-1-pdstate-off-and-pdtrtmnt-nan">
     9.1. Case 1: PDSTATE=OFF and PDTRTMNT=NaN
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-2-pdstate-nan-and-pdtrtmnt-0">
     9.2. Case 2: PDSTATE=NaN and PDTRTMNT=0
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-3-pdstate-nan-and-pdtrtmnt-1">
     9.3. Case 3: PDSTATE=NaN and PDTRTMNT=1
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-3-a-visits-with-two-exams">
       9.3.1. Case 3.a: visits with two exams
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-3-b-i-visits-with-one-exam-missing-examtm-or-pdmedtm">
       9.3.2. Case 3.b.i: visits with one exam, missing EXAMTM or PDMEDTM
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-3-b-ii-visits-with-one-exam-pdmedtm-earlier-than-examtm">
       9.3.3. Case 3.b.ii: visits with one exam, PDMEDTM earlier than EXAMTM
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#case-3-b-iii-pdmedtm-is-later-than-examtm">
       9.3.4. Case 3.b.iii: PDMEDTM is later than EXAMTM
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#case-3-b-iii-a-pdmedtm-is-after-4pm">
         9.3.4.1. Case 3.b.iii.a: PDMEDTM is after 4pm
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#case-3-b-iii-a-pdmedtm-is-before-4pm">
         9.3.4.2. Case 3.b.iii.a: PDMEDTM is before 4pm
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-4-pdstate-nan-and-pdtrtmnt-nan">
     9.4. Case 4: PDSTATE=NaN and PDTRTMNT=NaN
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#case-5-pdstate-on-and-pdtrtmnt-nan">
     9.5. Case 5: PDSTATE=ON and PDTRTMNT=NaN
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sanity-checks">
   10. ⚕️ Sanity checks
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="introduction">
<h1><span class="section-number">6. </span>👋 Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h1>
<p>The medication status of PD patients is important as medication importantly affects clinical measures such as the Hoehn &amp; Yahr score used in many studies. In PPMI, medication is available through the following main variables:</p>
<ul class="simple">
<li><p>PDSTATE (ON/OFF): the current functional state of the patient</p></li>
<li><p>PDTRTMNT (0/1): 1 if the participant is on PD medication or receives deep brain stimulation, 0 otherwise</p></li>
<li><p>PDMEDTM: time of most recent PD medication dose</p></li>
<li><p>PDMEDDT: date of most recent PD medication dose</p></li>
</ul>
<p>As mentioned in the “Methods for Defining PD Med Use” in PPMI study data, OFF state requires that the last dose of levodopa or dopamine agonist was taken 6 hours or more before MDS-UPDRS Part III assessment.</p>
<p>The goal of this notebook is (1) to identify and correct inconsistencies among these variables, (2) to impute missing data for PDSTATE and PDTRTMNT, and (3) to check the sanity of the corrected dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>

<span class="n">HTML</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;&lt;script&gt;</span>
<span class="sd">code_show=true; </span>
<span class="sd">function code_toggle() {</span>
<span class="sd"> if (code_show){</span>
<span class="sd"> $(&#39;div.input&#39;).hide();</span>
<span class="sd"> } else {</span>
<span class="sd"> $(&#39;div.input&#39;).show();</span>
<span class="sd"> }</span>
<span class="sd"> code_show = !code_show</span>
<span class="sd">} </span>
<span class="sd">$( document ).ready(code_toggle);</span>
<span class="sd">&lt;/script&gt;</span>
<span class="sd">&lt;form action=&quot;javascript:code_toggle()&quot;&gt;&lt;input type=&quot;submit&quot; value=&quot;Click here to toggle on/off the Python code.&quot;&gt;&lt;/form&gt;&quot;&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><script>
code_show=true; 
function code_toggle() {
 if (code_show){
 $('div.input').hide();
 } else {
 $('div.input').show();
 }
 code_show = !code_show
} 
$( document ).ready(code_toggle);
</script>
<form action="javascript:code_toggle()"><input type="submit" value="Click here to toggle on/off the Python code."></form></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">pytz</span>


<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z %z&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This notebook was run on </span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>This notebook was run on 2022-11-16 17:00:53 UTC +0000
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="data-download">
<h1><span class="section-number">7. </span>🔽 Data download<a class="headerlink" href="#data-download" title="Permalink to this headline">#</a></h1>
<p>The above-mentioned variables are available in PPMI file <code class="docutils literal notranslate"><span class="pre">MDS_UPDRS_Part_III.csv</span></code>. To download this file, we will use package <code class="docutils literal notranslate"><span class="pre">ppmi-downloader</span></code> available on PyPi. The package will ask you for your PPMI login and password.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">ppmi_downloader</span>


<span class="n">data_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="s1">&#39;study_files&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
<span class="n">required_files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MDS_UPDRS_Part_III.csv&quot;</span><span class="p">]</span>
<span class="n">missing_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">required_files</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">x</span><span class="p">))]</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">ppmi</span> <span class="o">=</span> <span class="n">ppmi_downloader</span><span class="o">.</span><span class="n">PPMIDownloader</span><span class="p">()</span>
    <span class="n">ppmi</span><span class="o">.</span><span class="n">download_metadata</span><span class="p">(</span>
        <span class="n">missing_files</span><span class="p">,</span> <span class="n">destination_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">600</span>
    <span class="p">)</span>
    <span class="n">ppmi</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;MDS_UPDRS_Part_III.csv&quot;</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File downloaded&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LivingPark-utils|DEBUG|ppmi_downloader.py:106 in __init__()
                       self.tempdir: &lt;TemporaryDirectory &#39;/tmp/tmp19d_5t6y&#39;&gt;
LivingPark-utils|DEBUG|ppmi_downloader.py:117 in __init__()
                       self.config_file: &#39;.ppmi_config&#39;
                       config_file: &#39;.ppmi_config&#39;
100%|███████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 647.27it/s]
LivingPark-utils|DEBUG|ppmi_navigator.py:64 in click_button()
                       &#39;Click button&#39;: &#39;Click button&#39;
                       field: &#39;ida-cookie-policy-accept&#39;
                       debug_name: &#39;Cookie Policy&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:33 in wait_for_element_to_be_visible()
                       &#39;Wait for element to be visible&#39;: &#39;Wait for element to be visible&#39;
                       field: &#39;ida-user-username&#39;
                       BY: &#39;class name&#39;
                       debug_name: &#39;&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:33 in wait_for_element_to_be_visible()
                       &#39;Wait for element to be visible&#39;: &#39;Wait for element to be visible&#39;
                       field: &#39;userEmail&#39;
                       BY: &#39;name&#39;
                       debug_name: &#39;&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:48 in enter_data()
                       &#39;Enter data&#39;: &#39;Enter data&#39;
                       field: &#39;userEmail&#39;
                       debug_name: &#39;Email&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:33 in wait_for_element_to_be_visible()
                       &#39;Wait for element to be visible&#39;: &#39;Wait for element to be visible&#39;
                       field: &#39;userPassword&#39;
                       BY: &#39;name&#39;
                       debug_name: &#39;&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:48 in enter_data()
                       &#39;Enter data&#39;: &#39;Enter data&#39;
                       field: &#39;userPassword&#39;
                       debug_name: &#39;Password&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:33 in wait_for_element_to_be_visible()
                       &#39;Wait for element to be visible&#39;: &#39;Wait for element to be visible&#39;
                       field: &#39;button&#39;
                       BY: &#39;tag name&#39;
                       debug_name: &#39;&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:64 in click_button()
                       &#39;Click button&#39;: &#39;Click button&#39;
                       field: &#39;button&#39;
                       debug_name: &#39;Login button&#39;
LivingPark-utils|INFO|&#39;Login Successful&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:64 in click_button()
                       &#39;Click button&#39;: &#39;Click button&#39;
                       field: &#39;ida-menu-option.sub-menu.download&#39;
                       debug_name: &#39;Download&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:64 in click_button()
                       &#39;Click button&#39;: &#39;Click button&#39;
                       field: &quot;//*[text()=&#39;Study Data&#39;]&quot;
                       debug_name: &#39;Study Data&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:64 in click_button()
                       &#39;Click button&#39;: &#39;Click button&#39;
                       field: &#39;ygtvlabelel71&#39;
                       debug_name: &#39;ALL&#39;
LivingPark-utils|DEBUG|ppmi_navigator.py:64 in click_button()
                       &#39;Click button&#39;: &#39;Click button&#39;
                       field: &#39;downloadBtn&#39;
                       debug_name: &#39;&#39;
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 69820
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 503112
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 878536
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 1312776
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 1758224
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 2199308
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 2615248
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 3030208
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 3475672
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 3907996
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 4410236
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 4854240
LivingPark-utils|DEBUG|ppmi_downloader.py:484 in download_complete()
                       &#39;Size&#39;: &#39;Size&#39;
                       size: 5301068
LivingPark-utils|INFO|f&quot;Successfully downloaded file {filename}&quot;: &#39;Successfully downloaded file MDS_UPDRS_Part_III.csv&#39;
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>File downloaded
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="inconsistencies">
<h1><span class="section-number">8. </span>⁉️ Inconsistencies<a class="headerlink" href="#inconsistencies" title="Permalink to this headline">#</a></h1>
<section id="records-with-no-value">
<h2><span class="section-number">8.1. </span>Records with no value<a class="headerlink" href="#records-with-no-value" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-danger">
     	&#10060; <b>Problem:</b> some records have missing data for all UPDRS-III variables.
</div><p>Number of records with NaNs for all UPDRS-III variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">updrs3_vars</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;PDMEDDT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PDMEDTM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EXAMTM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DBS_STATUS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3SPCH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3FACXP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RIGN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RIGRU&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RIGLU&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RIGRL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RIGLL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3FTAPR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3FTAPL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3HMOVR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3HMOVL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3PRSPR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3PRSPL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3TTAPR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3TTAPL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3LGAGR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3LGAGL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RISNG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3GAIT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3FRZGT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3PSTBL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3POSTR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3BRADY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3PTRMR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3PTRML&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3KTRMR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3KTRML&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RTARU&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RTALU&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RTARL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RTALL&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RTALJ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3RTCON&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NP3TOT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DYSKPRES&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DYSKIRAT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NHY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DBSONTM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DBSOFFTM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HRPOSTMED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HRDBSOFF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HRDBSON&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">updrs3_vars</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>207
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
     	&#10003; <b>Proposed correction</b>: remove these records.
</div><p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">updrs3_vars</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Updated number of records with NaNs for all UPDRS-III variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">updrs3_vars</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</section>
<section id="pdtrtmnt-0-and-pdstate-on">
<h2><span class="section-number">8.2. </span>PDTRTMNT=0 and PDSTATE=ON<a class="headerlink" href="#pdtrtmnt-0-and-pdstate-on" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-danger">
     	&#10060; <b>Problem:</b> a few records have PDSTATE=ON and PDTRTMNT=0, which is inconsistent:
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">OFF</th>
      <th>0.0</th>
      <td>18</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3257</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>6</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">ON</th>
      <th>0.0</th>
      <td>10</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>5550</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">NaN</th>
      <th>0.0</th>
      <td>8190</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>135</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The lines below show the difference between EXAMTM and PDMEDTM. All the records have a PDMEDTM that is earlier to EXAMTM by at most 5 hours:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ON&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
<span class="c1"># print the time difference between EXAMTM and PDMEDTM</span>
<span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6759    0 days 01:00:00
7617    0 days 01:00:00
8308    0 days 01:25:00
10795   0 days 04:30:00
11853   0 days 00:40:00
11883   0 days 00:00:00
11884   0 days 01:54:00
16299   0 days 03:50:00
17945   0 days 00:15:00
18473   0 days 05:00:00
dtype: timedelta64[ns]
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
     	&#10003; <b>Proposed correction</b>: set PDTRTMNT to 1 for these records. It doesn't seem realistic that a plausible PDMEDTM and PDSTATE=ON have been entered by mistake while the patient was not under medication.
</div><p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ON&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s verify that the inconsistency is now resolved:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">OFF</th>
      <th>0.0</th>
      <td>18</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3257</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>6</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5560</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">NaN</th>
      <th>0.0</th>
      <td>8190</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>135</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="pdtrtmnt-0-and-pdmedtm-not-empty">
<h2><span class="section-number">8.3. </span>PDTRTMNT=0 and PDMEDTM not empty<a class="headerlink" href="#pdtrtmnt-0-and-pdmedtm-not-empty" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-danger">
 	&#10060; <b>Problem:</b> some records have a non-empty PDMEDTIME and have PDTRTMNT=0, which is inconsistent.
    </div><p>Number of records with a non-empty PDMEDTIME and PDTRTMNT=0:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
<span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>474
</pre></div>
</div>
</div>
</div>
<p>PDMEDTIME values for these records look plausible:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">xrot</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of the day&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Number of records&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../_images/pd_status_30_0.png" src="../../../../_images/pd_status_30_0.png" />
</div>
</div>
<div class="alert alert-block alert-success">
    	&#10003; <b>Proposed correction:</b> set PDTRTMNT=1. It is unlikely that a plausible medication time was entered by mistake.
</div><p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()),</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s verify that the inconsistency is now fixed by counting the number of records with a non-empty PDMEDTIME and PDTRTMNT=0:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
<span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</section>
<section id="event-id-sc-and-pdtrtmnt-1">
<h2><span class="section-number">8.4. </span>EVENT_ID = SC and PDTRTMNT = 1<a class="headerlink" href="#event-id-sc-and-pdtrtmnt-1" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-danger">
     	&#10060; <b>Problem</b>: Some patients were on medication at screening time while PPMI patients were supposed to be unmedicated at screening time.
    </div><p>Number of patients on medication at screening time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EVENT_ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SC&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
     	&#10003; <b>Proposed correction:</b> keep the records. Maybe the patients started medication between recruitment and screening time.
</div></section>
<section id="pdstate-on-and-examtm-pdmedtm">
<h2><span class="section-number">8.5. </span>PDSTATE=ON and EXAMTM&lt;PDMEDTM<a class="headerlink" href="#pdstate-on-and-examtm-pdmedtm" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-danger">
     	&#10060; <b>Problem</b>: Some records have PDSTATE=ON but PDMEDTM is after EXAMTM. 
    </div><p>Number of records where PDSTATE=ON and EXAMTM&lt;PDMEDTM:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ON records</span>
<span class="n">on</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ON&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">to_secs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert time from hh:mm to seconds since midnight</span>

<span class="sd">    x: time in hh:ss format</span>
<span class="sd">    return: number of seconds elapsed since midnight</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hour</span><span class="p">,</span> <span class="n">mn</span><span class="p">,</span> <span class="n">sec</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot process &quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>


<span class="n">on</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">on</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">on</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">on</span><span class="p">[</span><span class="n">on</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>40
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
     	&#10003; <b>Proposed correction:</b> discard the records. 
</div><p>Note: for some of these records, medication date was likely on the day before the exam, although this cannot be verified since dates only contain a year and a month but no day. Even in such cases, duration between medication time and exam time was more than 6 hours which is inconsistent with the rule used for the other records.</p>
<p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
    <span class="o">~</span><span class="p">(</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ON&quot;</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">])</span>
    <span class="p">)</span>
<span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">before</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> records where PDSTATE=ON and EXAMTM&lt;PDMEDTM&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Removed 40 records where PDSTATE=ON and EXAMTM&lt;PDMEDTM
</pre></div>
</div>
</div>
</div>
</section>
<section id="visits-with-3-exams">
<h2><span class="section-number">8.6. </span>Visits with 3 exams<a class="headerlink" href="#visits-with-3-exams" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-danger">
    	&#10060; <b>Problem</b>: some visits have 3 exams while a maximum of two exams per visit are expected, one in OFF state and one in ON state.
</div><p>Number of records that belong to a visit with more than 3 exams:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pb</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PATNO&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT_ID&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>15
</pre></div>
</div>
</div>
</div>
<p>Each exams triple has an exam with missing EXAMTM and missing PDSTATE:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pb</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PATNO&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT_ID&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pb_trunc</span> <span class="o">=</span> <span class="n">pb</span><span class="p">[[</span><span class="s2">&quot;EVENT_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;EXAMTM&quot;</span><span class="p">]]</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>

<span class="n">HTML</span><span class="p">(</span><span class="n">pb_trunc</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>EVENT_ID</th>
      <th>PDSTATE</th>
      <th>EXAMTM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>V16</td>
      <td>OFF</td>
      <td>08:35:00</td>
    </tr>
    <tr>
      <td>V16</td>
      <td>ON</td>
      <td>09:36:00</td>
    </tr>
    <tr>
      <td>V16</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>V16</td>
      <td>ON</td>
      <td>12:45:00</td>
    </tr>
    <tr>
      <td>V16</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>V16</td>
      <td>OFF</td>
      <td>10:48:00</td>
    </tr>
    <tr>
      <td>V14</td>
      <td>ON</td>
      <td>12:00:00</td>
    </tr>
    <tr>
      <td>V14</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>V14</td>
      <td>OFF</td>
      <td>10:20:00</td>
    </tr>
    <tr>
      <td>V13</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>V13</td>
      <td>OFF</td>
      <td>09:18:00</td>
    </tr>
    <tr>
      <td>V13</td>
      <td>ON</td>
      <td>10:40:00</td>
    </tr>
    <tr>
      <td>V12</td>
      <td>OFF</td>
      <td>10:05:00</td>
    </tr>
    <tr>
      <td>V12</td>
      <td>ON</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>V12</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="alert alert-block alert-success">
  	&#10003;   <b>Proposed correction:</b> remove exam with EXAMTM=NaN and PDSTATE=NaN when visit has 3 exams.
</div><p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PATNO&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT_ID&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">[(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())])</span><span class="o">.</span><span class="n">index</span>

<span class="n">before_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of removed records: </span><span class="si">{</span><span class="n">before_len</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of removed records: 5
</pre></div>
</div>
</div>
</div>
<p>Let’s verify that the inconsistency is solved by counting the number of records that belong to a visit with more than 3 exams:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pb</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PATNO&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT_ID&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="imputation-of-missing-pdstate-or-pdtrtmnt">
<h1><span class="section-number">9. </span>🕵️ Imputation of missing PDSTATE or PDTRTMNT<a class="headerlink" href="#imputation-of-missing-pdstate-or-pdtrtmnt" title="Permalink to this headline">#</a></h1>
<div class="alert alert-block alert-danger">
    	&#10060; <b>Problem:</b> variables PDSTATE and PDTRTMNT have missing data, which makes it difficult to identify when/if a patient was under medication.
</div><p>The following table summarizes the number of records for which PDSTATE or PDTRTMNT is missing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">OFF</th>
      <th>0.0</th>
      <td>14</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3261</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>6</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5520</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">NaN</th>
      <th>0.0</th>
      <td>7715</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>605</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The following cases will be treated separately in the following sections:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>PDSTATE</p></th>
<th class="head"><p>PDTRTMNT</p></th>
<th class="head"><p>Number of records</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Case 1</strong></p></td>
<td><p>OFF</p></td>
<td><p>NaN</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Case 2</strong></p></td>
<td><p>NaN</p></td>
<td><p>0</p></td>
<td><p>6947</p></td>
</tr>
<tr class="row-even"><td><p><strong>Case 3</strong></p></td>
<td><p>NaN</p></td>
<td><p>1</p></td>
<td><p>633</p></td>
</tr>
<tr class="row-odd"><td><p><strong>Case 4</strong></p></td>
<td><p>NaN</p></td>
<td><p>NaN</p></td>
<td><p>2322</p></td>
</tr>
<tr class="row-even"><td><p><strong>Case 5</strong></p></td>
<td><p>ON</p></td>
<td><p>NaN</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
<section id="case-1-pdstate-off-and-pdtrtmnt-nan">
<h2><span class="section-number">9.1. </span>Case 1: PDSTATE=OFF and PDTRTMNT=NaN<a class="headerlink" href="#case-1-pdstate-off-and-pdtrtmnt-nan" title="Permalink to this headline">#</a></h2>
<p>No record in case 1 has a medication date (PDMEDDT), a medication time (PDMEDTM), or
a DBS status (DBS_STATUS):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OFF&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>
<span class="n">case_1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;PDMEDDT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PDMEDTM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DBS_STATUS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HRPOSTMED&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DBSONTM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DBSOFFTM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HRDBSOFF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HRDBSON&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDMEDDT</th>
      <th>PDMEDTM</th>
      <th>DBS_STATUS</th>
      <th>HRPOSTMED</th>
      <th>DBSONTM</th>
      <th>DBSOFFTM</th>
      <th>HRDBSOFF</th>
      <th>HRDBSON</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <td>6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="alert alert-block alert-success">
 	&#10003;    <b>Proposed correction</b>: set PDTRTMNT=0. It is unlikely that these records correspond to medicated patients when none of the variables related to medication have a value.
</div><p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OFF&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()),</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s verify that case 1 is now resolved:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>20</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3261</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5520</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">NaN</th>
      <th>0.0</th>
      <td>7715</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>605</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="case-2-pdstate-nan-and-pdtrtmnt-0">
<h2><span class="section-number">9.2. </span>Case 2: PDSTATE=NaN and PDTRTMNT=0<a class="headerlink" href="#case-2-pdstate-nan-and-pdtrtmnt-0" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-success">
   	&#10003;   <b>Proposed correction</b>: set PDSTATE=OFF. The patient is not medicated and for this reason PDSTATE is likely to not have been entered.
</div><p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OFF&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s verify that case 2 is now resolved:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>7735</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3261</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5520</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">NaN</th>
      <th>1.0</th>
      <td>605</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="case-3-pdstate-nan-and-pdtrtmnt-1">
<h2><span class="section-number">9.3. </span>Case 3: PDSTATE=NaN and PDTRTMNT=1<a class="headerlink" href="#case-3-pdstate-nan-and-pdtrtmnt-1" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-success">
    	&#10003; <b>Proposed correction</b>: 
    <ul>
        <li>(a) <b>IF</b> record belongs to a visit with two exams:</li>
            <ul>
                <li> Set PDSTATE=OFF for record with earliest EXAMTM</li>
                <li> Set PDSTATE=ON for record with latest EXAMTM</li>
            </ul>
        <li>(b) <b>ELSE</b>: determine PDSTATE as a function of PDMEDTM and EXAMTM:</li>
            <ul>
                <li>(i) <b>IF</b> PDMEDTM or EXAMTM are missing <b>THEN</b> discard record.</li>
                <li> (ii) <b>IF</b> PDMEDTM is earlier than EXAMTM:</li>
                    <ul>
                        <li><b>IF</b> EXAMTM-PDMEDTM < 6 hours (PPMI cut-off)<b>THEN</b>:
                <ul><li><b>IF</b> EXAMTM-PDMEDTM >= 30 min <b>THEN</b> set PDSTATE=ON.</li>
                    <li><b>ELSE</b>: discard record.</ul>
        <li><b>ELSE:</b> set PDSTATE=OFF</li>
                    </ul>
                <li> (iii) <b>IF</b> PDMEDTM is later than EXAMTM <b>THEN</b>:
                    <UL>
                        <li>(a) <b>IF</b> PDMEDTM is later than 4pm <b>THEN</b> assume record belongs to the previous day, set PDSTATE=OFF.</li>
                        <li>(b) <b>ELSE</b>                     
                    discard record.
                            </ul></li>
    </ul>
</div><p>⚙️ Implementation</p>
<p>Let’s implement each sub-case separately.</p>
<section id="case-3-a-visits-with-two-exams">
<h3><span class="section-number">9.3.1. </span>Case 3.a: visits with two exams<a class="headerlink" href="#case-3-a-visits-with-two-exams" title="Permalink to this headline">#</a></h3>
<p>Let’s count the number of records in case 3.a:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">case_3</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PATNO&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT_ID&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="si">}</span><span class="s2"> records in Case 3.a&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found 0 records in Case 3.a
</pre></div>
</div>
</div>
</div>
</section>
<section id="case-3-b-i-visits-with-one-exam-missing-examtm-or-pdmedtm">
<h3><span class="section-number">9.3.2. </span>Case 3.b.i: visits with one exam, missing EXAMTM or PDMEDTM<a class="headerlink" href="#case-3-b-i-visits-with-one-exam-missing-examtm-or-pdmedtm" title="Permalink to this headline">#</a></h3>
<p>Number of records in case 3.b with missing EXAMTM or missing PDMEDTM:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">case_3</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()))])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">before_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">case_3</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()))]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">before_len</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> record(s) with missing EXAMTM or PDMEDTM&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Removed 1 record(s) with missing EXAMTM or PDMEDTM
</pre></div>
</div>
</div>
</div>
<p>Updated records distribution in case 3:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>7735</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3261</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5520</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">NaN</th>
      <th>1.0</th>
      <td>604</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="case-3-b-ii-visits-with-one-exam-pdmedtm-earlier-than-examtm">
<h3><span class="section-number">9.3.3. </span>Case 3.b.ii: visits with one exam, PDMEDTM earlier than EXAMTM<a class="headerlink" href="#case-3-b-ii-visits-with-one-exam-pdmedtm-earlier-than-examtm" title="Permalink to this headline">#</a></h3>
<p>Number of records in case 3.b where PDMEDTM is earlier or equal to EXAMTM:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">case_3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">])])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>396
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">to_secs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;nan&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hour</span><span class="p">,</span> <span class="n">mn</span><span class="p">,</span> <span class="n">sec</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot process &quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Number of records in case 3.b where PDMEDTM is earlier or equal to EXAMTM and <span class="math notranslate nohighlight">\(30\,min \le \text{EXAMTM}-\text{PDMEDTM} &lt; 6\,hours\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="n">case_3</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1800</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>331
</pre></div>
</div>
</div>
</div>
<p>Let’s set PDSTATE=ON for these records.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">case_3</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1800</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">),</span>
    <span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span>
<span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ON&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Updated records distribution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>7735</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3261</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5851</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">NaN</th>
      <th>1.0</th>
      <td>273</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Number of records in case 3.b where PDMEDTM is earlier or equal to EXAMTM and <span class="math notranslate nohighlight">\(\text{EXAMTM-PDMEDTM} &lt; 30\,min\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="n">case_3</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1800</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>30
</pre></div>
</div>
</div>
</div>
<p>Let’s discard these records:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="n">case_3</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1800</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Updated records distribution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>7735</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3261</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5851</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">NaN</th>
      <th>1.0</th>
      <td>243</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Number of records in case 3.b where PDMEDTM is earlier or equal to EXAMTM and <span class="math notranslate nohighlight">\(\text{EXAMTM-PDMEDTM} \ge 6\,hours\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="n">case_3</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>35
</pre></div>
</div>
</div>
</div>
<p>Let’s set PDSTATE=OFF for these records.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">case_3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">),</span>
    <span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span>
<span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OFF&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Updated records distribution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>7735</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3296</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5851</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">NaN</th>
      <th>1.0</th>
      <td>208</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="case-3-b-iii-pdmedtm-is-later-than-examtm">
<h3><span class="section-number">9.3.4. </span>Case 3.b.iii: PDMEDTM is later than EXAMTM<a class="headerlink" href="#case-3-b-iii-pdmedtm-is-later-than-examtm" title="Permalink to this headline">#</a></h3>
<p>Number of records in case 3.b where PDMEDTM is later than EXAMTM:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">case_3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">])])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>208
</pre></div>
</div>
</div>
</div>
<section id="case-3-b-iii-a-pdmedtm-is-after-4pm">
<h4><span class="section-number">9.3.4.1. </span>Case 3.b.iii.a: PDMEDTM is after 4pm<a class="headerlink" href="#case-3-b-iii-a-pdmedtm-is-after-4pm" title="Permalink to this headline">#</a></h4>
<p>Some of records have a PDMEDTIME which likely belongs to the previous day but there is no way to confirm it because dates only include a month, a year, but no day. Looking at the distribution of exam times in such cases, we noticed that no exam took place after 4pm, which motivates the use of 4pm as cut-off time.</p>
<p>Distribution of EXAM times when <span class="math notranslate nohighlight">\(\text{PDMEDTM} &gt; \text{EXAMTM}\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">case_3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">))][</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of the day&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Number of EXAMTM records&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../_images/pd_status_120_0.png" src="../../../../_images/pd_status_120_0.png" />
</div>
</div>
<p>Number of records in case 3 where PDMEDTM is after EXAMTM and PDMEDTM is after 4pm:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span>
        <span class="n">case_3</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s2">&quot;16:00:00&quot;</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>120
</pre></div>
</div>
</div>
</div>
<p>Let’s set PDSTATE=OFF for these records:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">case_3</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">))</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="s2">&quot;16:00:00&quot;</span><span class="p">),</span>
    <span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span>
<span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OFF&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Updated records distribution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>7735</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3416</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5851</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">NaN</th>
      <th>1.0</th>
      <td>88</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="case-3-b-iii-a-pdmedtm-is-before-4pm">
<h4><span class="section-number">9.3.4.2. </span>Case 3.b.iii.a: PDMEDTM is before 4pm<a class="headerlink" href="#case-3-b-iii-a-pdmedtm-is-before-4pm" title="Permalink to this headline">#</a></h4>
<p>Number of records in case 3 where PDMEDTM is later than EXAMTM and PDMEDTM is before 4pm:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">case_3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">))])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>88
</pre></div>
</div>
</div>
</div>
<p>Let’s remove these records.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">case_3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">))]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s verify that case 3 (PDSTATE=NaN, PDTRTMNT=1) is now resolved:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>7735</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3416</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5851</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
    <tr>
      <th>NaN</th>
      <th>NaN</th>
      <td>2322</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
</section>
<section id="case-4-pdstate-nan-and-pdtrtmnt-nan">
<h2><span class="section-number">9.4. </span>Case 4: PDSTATE=NaN and PDTRTMNT=NaN<a class="headerlink" href="#case-4-pdstate-nan-and-pdtrtmnt-nan" title="Permalink to this headline">#</a></h2>
<p>Similar to case 1, no record in case 4 has a medication date (PDMEDDT), a medication time (PDMEDTM), or
a DBS status (DBS_STATUS):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">case_4</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())]</span>
<span class="n">case_4</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;PDMEDDT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PDMEDTM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DBS_STATUS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HRPOSTMED&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DBSONTM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DBSOFFTM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HRDBSOFF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HRDBSON&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th>REC_ID</th>
      <th>PATNO</th>
      <th>EVENT_ID</th>
      <th>PAG_NAME</th>
      <th>INFODT</th>
      <th>PDSTATE</th>
      <th>EXAMTM</th>
      <th>NP3SPCH</th>
      <th>NP3FACXP</th>
      <th>NP3RIGN</th>
      <th>...</th>
      <th>NP3RTALL</th>
      <th>NP3RTALJ</th>
      <th>NP3RTCON</th>
      <th>NP3TOT</th>
      <th>DYSKPRES</th>
      <th>DYSKIRAT</th>
      <th>NHY</th>
      <th>PDTRTMNT</th>
      <th>ORIG_ENTRY</th>
      <th>LAST_UPDATE</th>
    </tr>
    <tr>
      <th>PDMEDDT</th>
      <th>PDMEDTM</th>
      <th>DBS_STATUS</th>
      <th>HRPOSTMED</th>
      <th>DBSONTM</th>
      <th>DBSOFFTM</th>
      <th>HRDBSOFF</th>
      <th>HRDBSON</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <th>NaN</th>
      <td>2322</td>
      <td>2322</td>
      <td>2322</td>
      <td>2322</td>
      <td>2322</td>
      <td>0</td>
      <td>1135</td>
      <td>2322</td>
      <td>2322</td>
      <td>2321</td>
      <td>...</td>
      <td>2321</td>
      <td>2321</td>
      <td>2320</td>
      <td>2314</td>
      <td>2320</td>
      <td>40</td>
      <td>2320</td>
      <td>0</td>
      <td>2322</td>
      <td>2322</td>
    </tr>
  </tbody>
</table>
<p>1 rows × 47 columns</p>
</div></div></div>
</div>
<div class="alert alert-block alert-success">
    	&#10003; <b>Proposed solution</b>: set PDSTATE=OFF and PDTRTMNT=0. It is very unlikely that the patient was medicated and none of the 8 medication-related variables were set.
</div><p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()),</span> <span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;OFF&quot;</span>
<span class="n">df_1</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()),</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_1</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s verify that case 4 is now resolved:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>10057</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3416</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">ON</th>
      <th>1.0</th>
      <td>5851</td>
    </tr>
    <tr>
      <th>NaN</th>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="case-5-pdstate-on-and-pdtrtmnt-nan">
<h2><span class="section-number">9.5. </span>Case 5: PDSTATE=ON and PDTRTMNT=NaN<a class="headerlink" href="#case-5-pdstate-on-and-pdtrtmnt-nan" title="Permalink to this headline">#</a></h2>
<div class="alert alert-block alert-success">
    	&#10003; <b>Proposed correction</b>: set PDTRTMNT=1. The patient is medicated since PDSTATE=ON.
</div><p>⚙️ Implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ON&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()),</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s verify that case 5 is now resolved:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">,</span> <span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;REC_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>REC_ID</th>
    </tr>
    <tr>
      <th>PDSTATE</th>
      <th>PDTRTMNT</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">OFF</th>
      <th>0.0</th>
      <td>10057</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>3416</td>
    </tr>
    <tr>
      <th>ON</th>
      <th>1.0</th>
      <td>5852</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>There’s no remaining missing PDSTATE or PDTRTMNT value in the data!</p>
<p>Let’s save the cleaned file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;MDS_UPDRS_Part_III_clean.csv&quot;</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned file saved in </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cleaned file saved in MDS_UPDRS_Part_III_clean.csv
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="sanity-checks">
<h1><span class="section-number">10. </span>⚕️ Sanity checks<a class="headerlink" href="#sanity-checks" title="Permalink to this headline">#</a></h1>
<p>The following sanity checks are applied to the cleaned UPDRS-III data.</p>
<p><strong>IF</strong> visit has two exam <strong>THEN</strong> one is ON and the other one is OFF:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PATNO&#39;</span><span class="p">,</span> <span class="s1">&#39;EVENT_ID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PATNO&#39;</span><span class="p">,</span> <span class="s1">&#39;EVENT_ID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;PDSTATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span> <span class="o">==</span>
                                                  <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;PDSTATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span><span class="o">.</span><span class="n">empty</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p><strong>IF</strong> PDSTATE=ON <strong>THEN</strong> EXAMTM&gt;PDMEDTM</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ON&quot;</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;EXAMTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDMEDTM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">to_secs</span><span class="p">))</span>
<span class="p">]</span><span class="o">.</span><span class="n">empty</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p><strong>IF</strong> PDTRTMNT=0 <strong>THEN</strong> there is a single visit and PDSTATE=off</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PATNO&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT_ID&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">empty</span>
<span class="p">),</span> <span class="s2">&quot;False!&quot;</span>
<span class="k">assert</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PDTRTMNT&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;PATNO&quot;</span><span class="p">,</span> <span class="s2">&quot;EVENT_ID&quot;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;PDSTATE&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;OFF&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">empty</span>
<span class="p">),</span> <span class="s2">&quot;False!&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;True&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>A patient cannot become unmedicated after being medicated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wrong_pairs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="s1">&#39;EVENT_ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;EVENT_ID&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="c1"># If dates are equal, we cannot say anything</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;INFODT&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;INFODT&#39;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">False</span>                   
            <span class="c1"># If a is later than b, a[&#39;PDTRTMNT&#39;] has to be larger or equal to b[&#39;PDTRTMNT&#39;]</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;INFODT&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;INFODT&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;PDTRTMNT&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;PDTRTMNT&#39;</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="c1"># a is earlier than b: a[&#39;PDTRTMNT&#39;] has to be lower or equal to b[&#39;PDTRTMNT&#39;]</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;PDTRTMNT&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;PDTRTMNT&#39;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;PATNO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;PDTRTMNT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;PATNO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">wrong_pairs</span><span class="p">)</span><span class="o">.</span><span class="n">empty</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># off = (df[&#39;PDSTATE&#39;]==&#39;OFF&#39;) &amp; (df[&#39;PDMEDTM&#39;]&lt;=&#39;16:00:00&#39;)</span>
<span class="c1"># df[&#39;EXAMsecs&#39;] = df[off][&#39;EXAMTM&#39;].apply(to_secs)</span>
<span class="c1"># df[&#39;PDMEDTMsecs&#39;] = df[off][&#39;PDMEDTM&#39;].apply(to_secs)</span>

<span class="c1"># df[off &amp; (df[&#39;EXAMsecs&#39;]-df[&#39;PDMEDTMsecs&#39;]&gt;=0) &amp; (df[&#39;EXAMsecs&#39;]-df[&#39;PDMEDTMsecs&#39;]&lt;6*3600)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># off = (df[&#39;PDSTATE&#39;]==&#39;OFF&#39;) &amp; (df[&#39;PDMEDTM&#39;]&lt;=&#39;16:00:00&#39;)</span>
<span class="c1"># df[&#39;EXAMsecs&#39;] = df[off][&#39;EXAMTM&#39;].apply(to_secs)</span>
<span class="c1"># df[&#39;PDMEDTMsecs&#39;] = df[off][&#39;PDMEDTM&#39;].apply(to_secs)</span>

<span class="c1"># df[off &amp; (df[&#39;EXAMsecs&#39;]-df[&#39;PDMEDTMsecs&#39;]&gt;=0) &amp; (df[&#39;EXAMsecs&#39;]-df[&#39;PDMEDTMsecs&#39;]&lt;6*3600)]</span>
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters/livingpark-utils/livingpark_utils/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="mri_metadata.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">2. </span>Introduction</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By The LivingPark Project<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>